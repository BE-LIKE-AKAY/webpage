<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Love Proposal System</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-functions.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <style>
        /* Previous styles remain the same */
        /* Add these new styles */
        .proposal-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        .proposal-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .pending { background: #fff3cd; color: #856404; }
        .accepted { background: #d4edda; color: #155724; }
        .rejected { background: #f8d7da; color: #721c24; }
        .proposal-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .proposal-form {
            max-width: 600px;
            margin: 0 auto;
        }
        .proposal-response {
            text-align: center;
            margin-top: 30px;
        }
        .response-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .response-btn {
            padding: 12px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
        }
        .yes-btn {
            background-color: #28a745;
            color: white;
        }
        .no-btn {
            background-color: #dc3545;
            color: white;
        }
        .proposal-message {
            font-style: italic;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navigation (same as before) -->
    <div class="nav hidden" id="nav">
        <div class="container nav-container">
            <h1>Love Proposal</h1>
            <div class="nav-links">
                <a href="#" id="home-link">Home</a>
                <a href="#" id="profile-link">Profile</a>
                <a href="#" id="proposals-link">My Proposals</a>
                <a href="#" id="logout-link">Logout</a>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="container" id="main-content">
        <!-- All previous auth containers remain the same -->
        
        <!-- Home Page (updated) -->
        <div id="home-page" class="hidden">
            <h1>Welcome to Your Dashboard</h1>
            <div class="text-center">
                <button id="create-proposal-btn" class="link">Create New Proposal</button>
            </div>
            
            <div id="proposals-list" class="mt-20">
                <!-- Proposals will be loaded here -->
            </div>
        </div>

        <!-- Create Proposal Page -->
        <div id="create-proposal-page" class="hidden">
            <h1>Create New Proposal</h1>
            <div class="proposal-form">
                <form id="proposal-form">
                    <div class="form-group">
                        <label for="recipient-name">Recipient Name</label>
                        <input type="text" id="recipient-name" required>
                    </div>
                    <div class="form-group">
                        <label for="recipient-email">Recipient Email or Phone</label>
                        <input type="text" id="recipient-email" required>
                    </div>
                    <div class="form-group">
                        <label for="proposal-message">Your Message</label>
                        <textarea id="proposal-message" rows="5" style="width:100%; padding:10px;" required></textarea>
                    </div>
                    <button type="submit">Generate Proposal Link</button>
                    <div id="proposal-error" class="error-message"></div>
                    <div id="proposal-success" class="success-message"></div>
                </form>
            </div>
        </div>

        <!-- Proposal Response Page -->
        <div id="proposal-response-page" class="hidden">
            <div class="proposal-response">
                <h1 id="proposal-title">You Have a Proposal!</h1>
                <div class="proposal-message" id="proposal-display-message"></div>
                <div class="response-buttons">
                    <button class="response-btn yes-btn" id="accept-proposal">Yes</button>
                    <button class="response-btn no-btn" id="reject-proposal">No</button>
                </div>
                <div id="response-message" class="mt-20"></div>
            </div>
        </div>

        <!-- My Proposals Page -->
        <div id="my-proposals-page" class="hidden">
            <h1>My Proposals</h1>
            <div id="user-proposals-list">
                <!-- User's proposals will be loaded here -->
            </div>
        </div>

        <!-- Previous profile page remains the same -->
    </div>

    <script>
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
             apiKey: "AIzaSyBLx5RMGQAEsLi-4dkp2eGfdiofAp5CpdQ",
             authDomain: "marriage-proposal-96533.firebaseapp.com",
             projectId: "marriage-proposal-96533",
             storageBucket: "marriage-proposal-96533.firebasestorage.app",
             messagingSenderId: "1065582171317",
             appId: "1:1065582171317:web:1b94e30b5af34070a81afc",
             measurementId: "G-16539SVKXH"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        const messaging = firebase.messaging();

        // DOM Elements
        const createProposalBtn = document.getElementById('create-proposal-btn');
        const proposalsLink = document.getElementById('proposals-link');
        const createProposalPage = document.getElementById('create-proposal-page');
        const proposalResponsePage = document.getElementById('proposal-response-page');
        const myProposalsPage = document.getElementById('my-proposals-page');
        const proposalForm = document.getElementById('proposal-form');
        const acceptProposalBtn = document.getElementById('accept-proposal');
        const rejectProposalBtn = document.getElementById('reject-proposal');

        // Check for proposal ID in URL
        const urlParams = new URLSearchParams(window.location.search);
        const proposalId = urlParams.get('proposal');

        // On page load
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                if (user) {
                    showAuthenticatedUI(user);
                    
                    // Check if this is a proposal response page
                    if (proposalId) {
                        showProposalResponsePage(proposalId);
                    } else {
                        loadUserProposals(user.uid);
                    }
                } else {
                    showLoginUI();
                }
            });
            
            // Request notification permission
            requestNotificationPermission();
        });

        // Event Listeners
        createProposalBtn.addEventListener('click', () => {
            hideAllPages();
            createProposalPage.classList.remove('hidden');
        });

        proposalsLink.addEventListener('click', (e) => {
            e.preventDefault();
            hideAllPages();
            myProposalsPage.classList.remove('hidden');
            if (auth.currentUser) {
                loadUserProposals(auth.currentUser.uid);
            }
        });

        proposalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sender = auth.currentUser;
            if (!sender) return;
            
            const recipientName = document.getElementById('recipient-name').value;
            const recipientContact = document.getElementById('recipient-email').value;
            const message = document.getElementById('proposal-message').value;
            
            try {
                // Create proposal in Firestore
                const proposalRef = await db.collection('proposals').add({
                    senderId: sender.uid,
                    senderName: sender.displayName || 'Anonymous',
                    senderEmail: sender.email,
                    recipientName,
                    recipientContact,
                    message,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    viewed: false,
                    response: null,
                    responseTime: null,
                    viewerIP: null
                });
                
                // Generate shareable link
                const proposalLink = `${window.location.origin}${window.location.pathname}?proposal=${proposalRef.id}`;
                
                // Display success message with link
                document.getElementById('proposal-error').textContent = '';
                document.getElementById('proposal-success').innerHTML = `
                    Proposal created successfully!<br><br>
                    Share this link:<br>
                    <input type="text" value="${proposalLink}" style="width:100%; padding:8px; margin-top:10px;" readonly>
                    <button onclick="copyToClipboard('${proposalLink}')" style="margin-top:10px;">Copy Link</button>
                `;
                
                // Reset form
                proposalForm.reset();
                
                // Reload proposals list
                loadUserProposals(sender.uid);
                
                // TODO: In a real app, you would send the link via email/SMS here
                // You could use a Firebase Cloud Function for this
                
            } catch (error) {
                document.getElementById('proposal-error').textContent = error.message;
            }
        });

        acceptProposalBtn.addEventListener('click', async () => {
            await respondToProposal(proposalId, 'accepted');
        });

        rejectProposalBtn.addEventListener('click', async () => {
            await respondToProposal(proposalId, 'rejected');
        });

        // Helper functions
        function hideAllPages() {
            document.querySelectorAll('#main-content > div').forEach(div => {
                div.classList.add('hidden');
            });
        }

        async function showProposalResponsePage(proposalId) {
            try {
                hideAllPages();
                proposalResponsePage.classList.remove('hidden');
                
                const proposalDoc = await db.collection('proposals').doc(proposalId).get();
                if (!proposalDoc.exists) {
                    document.getElementById('proposal-display-message').textContent = 'Proposal not found';
                    return;
                }
                
                const proposal = proposalDoc.data();
                document.getElementById('proposal-display-message').textContent = proposal.message;
                document.getElementById('proposal-title').textContent = `${proposal.senderName} Wants to Know...`;
                
                // Record view information
                await recordProposalView(proposalId);
                
            } catch (error) {
                console.error('Error loading proposal:', error);
            }
        }

        async function recordProposalView(proposalId) {
            try {
                // Get viewer IP (simplified - in production use a proper IP detection method)
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                
                await db.collection('proposals').doc(proposalId).update({
                    viewed: true,
                    viewTime: firebase.firestore.FieldValue.serverTimestamp(),
                    viewerIP: ipData.ip
                });
                
                // Notify the sender that their proposal was viewed
                await notifyProposalView(proposalId);
                
            } catch (error) {
                console.error('Error recording view:', error);
            }
        }

        async function respondToProposal(proposalId, response) {
            try {
                const updateData = {
                    status: response,
                    response: response,
                    responseTime: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('proposals').doc(proposalId).update(updateData);
                
                document.getElementById('response-message').textContent = 
                    `You responded ${response}. The sender has been notified.`;
                
                acceptProposalBtn.disabled = true;
                rejectProposalBtn.disabled = true;
                
                // Notify the sender about the response
                await notifyProposalResponse(proposalId, response);
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 3000);
                
            } catch (error) {
                document.getElementById('response-message').textContent = 
                    `Error submitting response: ${error.message}`;
            }
        }

        async function loadUserProposals(userId) {
            try {
                const proposalsList = document.getElementById('user-proposals-list');
                proposalsList.innerHTML = '<p>Loading your proposals...</p>';
                
                const querySnapshot = await db.collection('proposals')
                    .where('senderId', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (querySnapshot.empty) {
                    proposalsList.innerHTML = '<p>You have no proposals yet.</p>';
                    return;
                }
                
                proposalsList.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const proposal = doc.data();
                    const statusClass = proposal.status || 'pending';
                    const viewedStatus = proposal.viewed ? 'Viewed' : 'Not viewed yet';
                    const responseStatus = proposal.response ? 
                        `Response: ${proposal.response}` : 'Waiting for response';
                    
                    const proposalCard = document.createElement('div');
                    proposalCard.className = 'proposal-card';
                    proposalCard.innerHTML = `
                        <span class="proposal-status ${statusClass}">${statusClass}</span>
                        <h3>To: ${proposal.recipientName} (${proposal.recipientContact})</h3>
                        <p>${proposal.message}</p>
                        <p><small>Sent: ${new Date(proposal.createdAt?.toDate()).toLocaleString()}</small></p>
                        <p><small>${viewedStatus} | ${responseStatus}</small></p>
                        <div class="proposal-actions">
                            <button onclick="shareProposal('${doc.id}')">Share Again</button>
                            <button onclick="viewProposal('${doc.id}')">View Details</button>
                        </div>
                    `;
                    proposalsList.appendChild(proposalCard);
                });
                
            } catch (error) {
                console.error('Error loading proposals:', error);
            }
        }

        async function notifyProposalView(proposalId) {
            // In a real app, you would implement this using Firebase Cloud Messaging
            // or send an email notification via a Cloud Function
            console.log(`Proposal ${proposalId} was viewed - notification would be sent here`);
        }

        async function notifyProposalResponse(proposalId, response) {
            // In a real app, you would implement this using Firebase Cloud Messaging
            // or send an email notification via a Cloud Function
            console.log(`Proposal ${proposalId} got response ${response} - notification would be sent here`);
            
            // Example of how you might implement this with a Cloud Function:
            // const sendNotification = functions.httpsCallable('sendProposalResponseNotification');
            // await sendNotification({ proposalId, response });
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    // You would set up Firebase Cloud Messaging here
                }
            });
        }

        // Global functions for buttons
        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Link copied to clipboard!');
            });
        };

        window.shareProposal = function(proposalId) {
            const proposalLink = `${window.location.origin}${window.location.pathname}?proposal=${proposalId}`;
            if (navigator.share) {
                navigator.share({
                    title: 'You have a proposal!',
                    text: 'Someone wants to know your answer...',
                    url: proposalLink,
                }).catch(console.error);
            } else {
                // Fallback for browsers that don't support Web Share API
                copyToClipboard(proposalLink);
            }
        };

        window.viewProposal = function(proposalId) {
            window.open(`?proposal=${proposalId}`, '_blank');
        };

        // All previous authentication code remains the same
    </script>
</body>
</html>  
